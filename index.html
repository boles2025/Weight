<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Dashboard | ØªØµÙ…ÙŠÙ… Ù…. Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --text-primary: #2d3748;
            --accent-color: #764ba2;
            --success-color: #48bb78;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Card Style */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
        }

        .card-header {
            background: rgba(255, 255, 255, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1rem 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            display: flex;
            align-items: center;
        }

        .card-header i {
            background: rgba(118, 75, 162, 0.1);
            padding: 8px;
            border-radius: 10px;
            margin-left: 10px;
        }

        /* Inputs & Forms */
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(118, 75, 162, 0.2);
            border-radius: 12px;
            padding: 0.7rem 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            background: white;
            box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.1);
            border-color: var(--accent-color);
        }

        /* Buttons */
        .btn-custom {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 30px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(118, 75, 162, 0.4);
            color: white;
        }

        /* Header Section */
        .main-header {
            text-align: center;
            padding: 2rem 0;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .designer-badge {
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.85rem;
            backdrop-filter: blur(4px);
            display: inline-block;
            margin-top: 10px;
        }

        /* Stat Boxes */
        .stat-card-mini {
            background: rgba(255,255,255,0.6);
            border-radius: 15px;
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s;
            height: 100%;
        }
        
        .stat-icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 5px;
            font-size: 1.1rem;
            color: white;
        }

        /* Water Cups */
        .water-grid {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .water-cup {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(233, 236, 239, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .water-cup.filled {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
            transform: scale(1.1);
        }
        
        .water-cup.filled i { color: white; }

        /* Medications */
        .medication-item {
            background: white;
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            border-right: 4px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .medication-item:hover {
            transform: translateX(-5px);
            border-right-color: var(--accent-color);
        }

        .checkmark-custom {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #cbd5e0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkmark-custom.checked {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        /* Login Container */
        .login-glass {
            max-width: 450px;
            margin: 80px auto;
            padding: 40px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        /* Footer */
        .footer-glass {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 15px;
            margin-top: 40px;
            color: white;
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="container animate__animated animate__fadeIn">
        <div class="login-glass text-center">
            <div class="mb-4">
                <i class="fas fa-heartbeat fa-3x" style="color: #764ba2;"></i>
            </div>
            <h2 class="fw-bold mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p class="text-muted mb-4">Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ­Ø© - Ù…. Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</p>
            
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="loginEmail" placeholder="name@example.com">
                <label for="loginEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            </div>
            
            <div class="form-floating mb-4">
                <input type="password" class="form-control" id="loginPassword" placeholder="Password">
                <label for="loginPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            </div>
            
            <button id="loginBtn" class="btn btn-custom w-100 mb-3">Ø¯Ø®ÙˆÙ„</button>
            <button id="signupBtn" class="btn btn-outline-secondary w-100 rounded-pill">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>

    <div id="appContainer" class="container-fluid pb-4" style="display: none;">
        
        <header class="main-header animate__animated animate__fadeInDown">
            <h1><i class="fas fa-heartbeat animate__animated animate__pulse animate__infinite"></i> Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ­Ø©</h1>
            <div class="designer-badge">
                <i class="fas fa-code me-1"></i> ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±
            </div>
            <div class="mt-3">
                <button id="logoutBtn" class="btn btn-sm btn-light rounded-pill px-3">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div class="container">
            <div class="alert alert-light text-center shadow-sm animate__animated animate__fadeInUp" style="border-radius: 15px; background: rgba(255,255,255,0.9);">
                <i class="fas fa-clock me-2 text-danger"></i> 
                <strong>Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹:</strong> 18 Ø³Ø§Ø¹Ø© (Ù…Ù† 9 Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ 3 Ø¸Ù‡Ø±Ù‹Ø§)
            </div>

            <div class="row">
                <div class="col-lg-8 animate__animated animate__fadeInLeft">
                    
                    <div class="glass-card">
                        <div class="card-header">
                            <i class="fas fa-calendar-day"></i> Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙŠÙˆÙ…
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                                    <input type="date" class="form-control" id="entryDate">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">Ø§Ù„ÙŠÙˆÙ… (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                                    <input type="text" class="form-control bg-light" id="entryDay" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <div class="card-header">
                            <i class="fas fa-weight-scale"></i> ØªØªØ¨Ø¹ Ø§Ù„ÙˆØ²Ù†
                        </div>
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div class="flex-grow-1 ms-3">
                                    <label class="small text-muted mb-1">ÙˆØ²Ù† Ø§Ù„ÙŠÙˆÙ…</label>
                                    <input type="number" step="0.1" class="form-control form-control-lg text-center fw-bold fs-3" id="weightInput" placeholder="0.0">
                                </div>
                                <div class="text-center px-4 border-start border-end">
                                    <div class="small text-muted">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                                    <div class="fs-4 fw-bold text-primary" id="currentWeightDisplay">--</div>
                                </div>
                                <div class="text-center px-2">
                                    <div class="small text-muted">Ø§Ù„Ù‡Ø¯Ù</div>
                                    <div class="fs-5 fw-bold text-success" id="targetWeightDisplay">--</div>
                                </div>
                            </div>
                            <div class="progress" style="height: 10px; border-radius: 10px;">
                                <div class="progress-bar bg-gradient-primary" id="weightProgress" role="progressbar" style="width: 0%; border-radius: 10px; background: linear-gradient(to right, #667eea, #764ba2);"></div>
                            </div>
                            <div class="d-none" id="initialWeight"></div>
                            <div class="d-none" id="targetWeightStored"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="glass-card h-100">
                                <div class="card-header">
                                    <i class="fas fa-glass-water"></i> Ø§Ù„Ù…ÙŠØ§Ù‡
                                </div>
                                <div class="card-body text-center p-4">
                                    <div class="d-flex justify-content-center align-items-center mb-2">
                                        <button class="btn btn-sm btn-light rounded-circle border" id="decreaseWater">-</button>
                                        <div class="mx-3">
                                            <span class="fs-2 fw-bold" id="waterDisplay" style="color: #4facfe;">0/8</span>
                                        </div>
                                        <button class="btn btn-sm btn-light rounded-circle border" id="increaseWater">+</button>
                                        <input type="hidden" id="waterInput" value="0">
                                    </div>
                                    <div class="water-grid" id="waterCupsContainer"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="glass-card h-100">
                                <div class="card-header">
                                    <i class="fas fa-running"></i> Ø§Ù„Ø±ÙŠØ§Ø¶Ø©
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">Ø§Ù„Ù…Ø´ÙŠ (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                                        <input type="number" class="form-control" id="walkingInput" placeholder="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">ØªÙ…Ø±ÙŠÙ† Ø¨Ù„Ø§Ù†Ùƒ (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                                        <input type="number" class="form-control" id="plankInput" placeholder="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="glass-card h-100">
                                <div class="card-header">
                                    <i class="fas fa-pills"></i> Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
                                </div>
                                <div class="card-body p-3" id="medicationsList"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="glass-card h-100">
                                <div class="card-header">
                                    <i class="fas fa-utensils"></i> Ø§Ù„ÙˆØ¬Ø¨Ø§Øª
                                </div>
                                <div class="card-body p-3">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="mealDescription" placeholder="Ø§Ù„ÙˆØµÙ">
                                        <input type="text" class="form-control" id="mealTimeInput" placeholder="Ø§Ù„ÙˆÙ‚Øª" style="max-width: 80px;">
                                        <button class="btn btn-outline-secondary" type="button" id="setCurrentMealTime"><i class="far fa-clock"></i></button>
                                    </div>
                                    <button class="btn btn-sm btn-custom w-100 mb-3" id="addMealBtn">Ø¥Ø¶Ø§ÙØ©</button>
                                    <div id="mealsList" style="max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="saveDayBtn" class="btn btn-custom btn-lg w-100 shadow-lg mb-2 animate__animated animate__pulse animate__infinite animate__slow">
                        <i class="fas fa-save me-2"></i> Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…
                    </button>
                    
                    <button id="resetDayBtn" class="btn btn-danger btn-sm w-100 mb-4">
                        <i class="fas fa-trash-alt me-2"></i> ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…
                    </button>

                </div>

                <div class="col-lg-4 animate__animated animate__fadeInRight mt-4 mt-lg-0">
                    
                    <div class="glass-card">
                        <div class="card-header">
                            <i class="fas fa-chart-pie"></i> Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="stat-card-mini">
                                        <div class="stat-icon-circle" style="background: #ff6b6b;"><i class="fas fa-weight"></i></div>
                                        <div class="fw-bold" id="todayWeightStat">--</div>
                                        <div class="small text-muted">Ø§Ù„ÙˆØ²Ù†</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card-mini">
                                        <div class="stat-icon-circle" style="background: #4facfe;"><i class="fas fa-tint"></i></div>
                                        <div class="fw-bold" id="todayWaterStat">0/8</div>
                                        <div class="small text-muted">Ù…ÙŠØ§Ù‡</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card-mini">
                                        <div class="stat-icon-circle" style="background: #48bb78;"><i class="fas fa-walking"></i></div>
                                        <div class="fw-bold" id="todayWalkStat">--</div>
                                        <div class="small text-muted">Ù…Ø´ÙŠ</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card-mini">
                                        <div class="stat-icon-circle" style="background: #f6ad55;"><i class="fas fa-dumbbell"></i></div>
                                        <div class="fw-bold" id="todayPlankStat">--</div>
                                        <div class="small text-muted">Ø¨Ù„Ø§Ù†Ùƒ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i> ØªØ·ÙˆØ± Ø§Ù„ÙˆØ²Ù†
                        </div>
                        <div class="card-body p-2 bg-white rounded-bottom">
                            <div style="height: 200px;">
                                <canvas id="weightChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <div class="card-header d-flex justify-content-between">
                            <span><i class="fas fa-history"></i> Ø§Ù„Ø³Ø¬Ù„</span>
                            <button id="loadMoreHistory" class="btn btn-xs btn-link p-0 text-decoration-none">Ø§Ù„Ù…Ø²ÙŠØ¯</button>
                        </div>
                        <div class="card-body p-3" id="historyList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>

                    <div class="glass-card text-center p-3">
                        <button class="btn btn-success w-100 mb-2" id="exportTodayBtn">
                            <i class="fas fa-print me-2"></i> Ø·Ø¨Ø§Ø¹Ø© / ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <footer class="footer-glass text-center">
            <p class="mb-0">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; <span id="currentYear"></span></p>
            <small class="opacity-75">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</small>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDkqqU_3KbEW_FFFK-Sy8QASI0-jsAfycM",
            authDomain: "health-ea6cd.firebaseapp.com",
            projectId: "health-ea6cd",
            storageBucket: "health-ea6cd.firebasestorage.app",
            messagingSenderId: "836059005460",
            appId: "1:836059005460:web:9d3768d1925288322e9d01"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Globals
        let currentUser = null;
        let todayData = {};
        let weightHistory = [];
        let weightChart = null;
        
        const daysInArabic = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        const medications = [
            { id: 1, name: "Ø³ÙˆØ¯ÙØ§Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡", checked: false },
            { id: 2, name: "ÙƒÙˆÙŠÙƒ Ø³Ù„ÙŠÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØºØ¯Ø§Ø¡", checked: false },
            { id: 3, name: "Ø¬Ø±ÙˆØ³Ù„ÙŠÙ… Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡ Ø¨Ù†Øµ Ø³Ø§Ø¹Ù‡", checked: false }
        ];
        
        // Elements
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const entryDate = document.getElementById('entryDate');
        const entryDay = document.getElementById('entryDay');
        const weightInput = document.getElementById('weightInput');
        const targetWeightDisplay = document.getElementById('targetWeightDisplay');
        const walkingInput = document.getElementById('walkingInput');
        const plankInput = document.getElementById('plankInput');
        const saveDayBtn = document.getElementById('saveDayBtn');
        const resetDayBtn = document.getElementById('resetDayBtn'); // New Element
        const waterInput = document.getElementById('waterInput');
        
        // Stats Elements
        const todayWeightStat = document.getElementById('todayWeightStat');
        const todayWaterStat = document.getElementById('todayWaterStat');
        const todayWalkStat = document.getElementById('todayWalkStat');
        const todayPlankStat = document.getElementById('todayPlankStat');

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Set initial date & auto-day
            const today = new Date();
            entryDate.valueAsDate = today; 
            updateDayFromDate(); // Calculate day automatically

            initWaterCups();
            renderMedications();
            initEventListeners();
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showApp();
                    loadUserData();
                } else {
                    showLogin();
                }
            });

            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('signupBtn').addEventListener('click', handleSignup);
            document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        });

        function initEventListeners() {
            // Auto Date Logic
            entryDate.addEventListener('change', function() {
                updateDayFromDate();
                loadDayData();
            });

            // Water
            document.getElementById('decreaseWater').addEventListener('click', () => {
                waterInput.value = Math.max(0, parseInt(waterInput.value) - 1);
                updateWaterDisplay();
            });
            document.getElementById('increaseWater').addEventListener('click', () => {
                waterInput.value = Math.min(20, parseInt(waterInput.value) + 1);
                updateWaterDisplay();
            });
            waterInput.addEventListener('change', updateWaterDisplay);

            // Meal Time
            document.getElementById('setCurrentMealTime').addEventListener('click', () => {
                const now = new Date();
                let h = now.getHours(), m = now.getMinutes();
                const ampm = h >= 12 ? 'Ù…' : 'Øµ';
                h = h % 12 || 12;
                m = m < 10 ? '0'+m : m;
                document.getElementById('mealTimeInput').value = `${h}:${m} ${ampm}`;
            });

            document.getElementById('addMealBtn').addEventListener('click', addMeal);
            saveDayBtn.addEventListener('click', saveDayData);
            resetDayBtn.addEventListener('click', resetDayData); // New Event Listener
            document.getElementById('loadMoreHistory').addEventListener('click', loadHistory);
            document.getElementById('exportTodayBtn').addEventListener('click', generateFancyReport);
        }

        // New Feature: Auto Calculate Day
        function updateDayFromDate() {
            const dateVal = entryDate.value;
            if (!dateVal) return;
            const dateObj = new Date(dateVal);
            entryDay.value = daysInArabic[dateObj.getDay()];
        }

        function showLogin() { loginScreen.style.display = 'block'; appContainer.style.display = 'none'; }
        function showApp() { loginScreen.style.display = 'none'; appContainer.style.display = 'block'; }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
        }

        function handleSignup() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            auth.createUserWithEmailAndPassword(email, password)
                .then(cred => { currentUser = cred.user; showApp(); initializeUserData(); })
                .catch(e => alert(e.message));
        }

        function initializeUserData() {
            database.ref('users/' + currentUser.uid).set({
                email: currentUser.email,
                initialWeight: 0,
                targetWeight: 0,
                createdAt: new Date().toISOString()
            }).then(() => loadUserData());
        }

        function loadUserData() {
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('initialWeight').textContent = userData.initialWeight || 0;
                    document.getElementById('targetWeightStored').textContent = userData.targetWeight || 0;
                    
                    // Fix: Display Target Weight
                    targetWeightDisplay.textContent = (userData.targetWeight || '--') + ' ÙƒØ¬Ù…';

                    if (!userData.initialWeight) {
                        const w = prompt('Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙƒØ¬Ù…):');
                        if (w) userRef.update({ initialWeight: parseFloat(w) });
                    }
                    if (!userData.targetWeight) {
                        const t = prompt('Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù‡Ø¯Ù (ÙƒØ¬Ù…):');
                        if (t) {
                            userRef.update({ targetWeight: parseFloat(t) });
                            targetWeightDisplay.textContent = t + ' ÙƒØ¬Ù…';
                        }
                    }
                }
                loadDayData();
                loadWeightHistory();
                loadHistory();
            });
        }

        function loadDayData() {
            const date = entryDate.value;
            if (!currentUser) return;
            
            // Reset UI first
            resetForm();

            database.ref('users/' + currentUser.uid + '/days/' + date).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    todayData = data;
                    
                    if (data.weight) {
                        weightInput.value = data.weight;
                        document.getElementById('currentWeightDisplay').textContent = data.weight;
                        todayWeightStat.textContent = data.weight;
                        updateWeightProgress(data.weight);
                    }
                    
                    if (data.water) {
                        waterInput.value = data.water;
                        updateWaterDisplay();
                    }
                    
                    // Fix: Load Walking & Plank correctly
                    if (data.walking) {
                        walkingInput.value = data.walking;
                        todayWalkStat.textContent = data.walking;
                    }
                    if (data.plank) {
                        plankInput.value = data.plank;
                        todayPlankStat.textContent = data.plank;
                    }

                    if (data.medications) {
                        medications.forEach((m, i) => {
                            if (data.medications[i]) medications[i].checked = data.medications[i].checked;
                        });
                        renderMedications();
                    }
                    
                    if (data.meals) {
                        todayData.meals = data.meals; // Ensure local variable is synced
                        renderMeals(data.meals);
                    }
                } else {
                    todayData = {};
                }
            });
        }

        function saveDayData() {
            if (!currentUser) return;
            const date = entryDate.value;
            
            // Fix: Capture Inputs Correctly
            const weightVal = parseFloat(weightInput.value);
            const walkVal = parseInt(walkingInput.value) || 0;
            const plankVal = parseInt(plankInput.value) || 0;
            const waterVal = parseInt(waterInput.value) || 0;

            const dayData = {
                date: date,
                day: entryDay.value,
                weight: weightVal || null,
                water: waterVal,
                medications: medications,
                walking: walkVal, // Ensuring this is saved
                plank: plankVal,   // Ensuring this is saved
                meals: todayData.meals || [],
                savedAt: new Date().toISOString()
            };

            database.ref('users/' + currentUser.uid + '/days/' + date).set(dayData)
                .then(() => {
                    saveDayBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸';
                    saveDayBtn.classList.replace('btn-custom', 'btn-success');
                    
                    // Update Stats Immediate Feedback
                    if (weightVal) {
                        document.getElementById('currentWeightDisplay').textContent = weightVal;
                        todayWeightStat.textContent = weightVal;
                        updateWeightProgress(weightVal);
                    }
                    todayWalkStat.textContent = walkVal;
                    todayPlankStat.textContent = plankVal;

                    setTimeout(() => {
                        saveDayBtn.innerHTML = '<i class="fas fa-save me-2"></i> Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…';
                        saveDayBtn.classList.replace('btn-success', 'btn-custom');
                    }, 2000);
                    
                    todayData = dayData;
                    loadWeightHistory();
                    loadHistory();
                })
                .catch(e => alert(e.message));
        }

        // New Function: Reset Day Data
        function resetDayData() {
            if (!currentUser) return;
            const date = entryDate.value;

            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠÙˆÙ… ${date}ØŸ`)) {
                database.ref('users/' + currentUser.uid + '/days/' + date).remove()
                    .then(() => {
                        todayData = {};
                        resetForm();
                        alert('ØªÙ… ØªØµÙÙŠØ± ÙˆØ­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­.');
                        loadWeightHistory();
                        loadHistory();
                    })
                    .catch(e => alert('ÙØ´Ù„ Ø§Ù„ØªØµÙÙŠØ±: ' + e.message));
            }
        }

        // New Feature: Attractive HTML Report
        function generateFancyReport() {
            if (!todayData || Object.keys(todayData).length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§');
                return;
            }

            const win = window.open('', '', 'height=700,width=900');
            const date = entryDate.value;
            const day = entryDay.value;
            
            // Calculate Meds
            const medsTaken = medications.filter(m => m.checked).length;
            const medsTotal = medications.length;

            let mealsHtml = '';
            if (todayData.meals && todayData.meals.length > 0) {
                todayData.meals.forEach(m => {
                    mealsHtml += `<tr><td>${m.time}</td><td>${m.description}</td></tr>`;
                });
            } else {
                mealsHtml = '<tr><td colspan="2" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ¬Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
            }

            // Report HTML Structure
            const html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <title>ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ - ${date}</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f9f9f9; }
                        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; border: 1px solid #ddd; }
                        .header { text-align: center; border-bottom: 2px solid #764ba2; padding-bottom: 20px; margin-bottom: 20px; }
                        .header h1 { color: #764ba2; margin: 0; }
                        .meta { display: flex; justify-content: space-between; margin-bottom: 30px; font-weight: bold; background: #f0f0f0; padding: 10px; border-radius: 8px; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
                        .box { border: 1px solid #eee; padding: 15px; border-radius: 10px; }
                        .box h3 { margin-top: 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                        .stat-big { font-size: 24px; font-weight: bold; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                        th { background-color: #f2f2f2; }
                        .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #777; border-top: 1px solid #eee; padding-top: 10px; }
                        @media print { body { background: white; } .container { border: none; } .print-only { display: block; } .no-print { display: none; } }
                        .no-print { text-align: center; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
                            <p>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„ØªØºØ°ÙŠØ©</p>
                        </div>
                        <div class="meta">
                            <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}</span>
                            <span>Ø§Ù„ÙŠÙˆÙ…: ${day}</span>
                        </div>

                        <div class="grid">
                            <div class="box">
                                <h3><span style="color:#ff6b6b">â¤</span> Ø§Ù„ÙˆØ²Ù†</h3>
                                <div class="stat-big">${todayData.weight || '--'} ÙƒØ¬Ù…</div>
                            </div>
                            <div class="box">
                                <h3><span style="color:#4facfe">ğŸ’§</span> Ø§Ù„Ù…ÙŠØ§Ù‡</h3>
                                <div class="stat-big">${todayData.water || 0} / 8 Ø£ÙƒÙˆØ§Ø¨</div>
                            </div>
                            <div class="box">
                                <h3><span style="color:#48bb78">ğŸƒâ€â™‚ï¸</span> Ø§Ù„Ø±ÙŠØ§Ø¶Ø©</h3>
                                <div>Ø§Ù„Ù…Ø´ÙŠ: <strong>${todayData.walking || 0}</strong> Ø¯Ù‚ÙŠÙ‚Ø©</div>
                                <div>Ø¨Ù„Ø§Ù†Ùƒ: <strong>${todayData.plank || 0}</strong> Ø¯Ù‚ÙŠÙ‚Ø©</div>
                            </div>
                            <div class="box">
                                <h3><span style="color:#f6ad55">ğŸ’Š</span> Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h3>
                                <div class="stat-big">${medsTaken} / ${medsTotal}</div>
                            </div>
                        </div>

                        <div class="box" style="margin-bottom: 20px;">
                            <h3>ğŸ½ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h3>
                            <table>
                                <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„ÙˆØµÙ</th></tr></thead>
                                <tbody>${mealsHtml}</tbody>
                            </table>
                        </div>

                        <div class="footer">
                            <p>ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ±: Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</p>
                            <p>ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØªØ§Ø±ÙŠØ® ${new Date().toLocaleString('ar-EG')}</p>
                        </div>

                        <div class="no-print">
                            <button onclick="window.print()" style="padding: 10px 20px; margin: 5px; background-color: #4facfe; color: white; border: none; border-radius: 5px; cursor: pointer;">Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button onclick="window.close()" style="padding: 10px 20px; margin: 5px; background-color: #764ba2; color: white; border: none; border-radius: 5px; cursor: pointer;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            win.document.write(html);
            win.document.close();
        }

        // Helper Functions (Same logic, cleaner code)
        function initWaterCups() {
            const container = document.getElementById('waterCupsContainer');
            container.innerHTML = '';
            for (let i = 1; i <= 8; i++) {
                const cup = document.createElement('div');
                cup.className = 'water-cup';
                cup.dataset.index = i;
                cup.innerHTML = '<i class="fas fa-glass-water"></i>';
                cup.onclick = function() { waterInput.value = this.dataset.index; updateWaterDisplay(); };
                container.appendChild(cup);
            }
        }

        function updateWaterDisplay() {
            const val = parseInt(waterInput.value) || 0;
            document.getElementById('waterDisplay').textContent = val + '/8';
            todayWaterStat.textContent = val + '/8';
            document.querySelectorAll('.water-cup').forEach((c, i) => {
                c.classList.toggle('filled', i < val);
            });
        }

        function renderMedications() {
            const list = document.getElementById('medicationsList');
            list.innerHTML = '';
            medications.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = 'medication-item';
                div.innerHTML = `
                    <div class="fw-bold small">${m.name}</div>
                    <div class="checkmark-custom ${m.checked ? 'checked' : ''}" onclick="toggleMed(${i})">
                        ${m.checked ? '<i class="fas fa-check text-white"></i>' : ''}
                    </div>`;
                list.appendChild(div);
            });
        }

        window.toggleMed = function(i) {
            medications[i].checked = !medications[i].checked;
            renderMedications();
        }

        function addMeal() {
            const t = document.getElementById('mealTimeInput').value;
            const d = document.getElementById('mealDescription').value;
            if(!t || !d) return;
            if(!todayData.meals) todayData.meals = [];
            todayData.meals.push({time: t, description: d});
            renderMeals(todayData.meals);
            document.getElementById('mealTimeInput').value = '';
            document.getElementById('mealDescription').value = '';
        }

        function renderMeals(arr) {
            const list = document.getElementById('mealsList');
            list.innerHTML = '';
            arr.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between p-2 bg-light mb-2 rounded border';
                div.innerHTML = `<span><b>${m.description}</b> <small>(${m.time})</small></span> <i class="fas fa-trash text-danger" style="cursor:pointer" onclick="deleteMeal(${i})"></i>`;
                list.appendChild(div);
            });
        }

        window.deleteMeal = function(i) {
            todayData.meals.splice(i, 1);
            renderMeals(todayData.meals);
        }

        function updateWeightProgress(curr) {
            const init = parseFloat(document.getElementById('initialWeight').textContent) || 0;
            const target = parseFloat(document.getElementById('targetWeightStored').textContent) || 0;
            if(init && target) {
                const total = init - target;
                const lost = init - curr;
                const pct = Math.min(100, Math.max(0, (lost/total)*100));
                document.getElementById('weightProgress').style.width = pct + '%';
            }
        }

        function resetForm() {
            weightInput.value = ''; walkingInput.value = ''; plankInput.value = ''; waterInput.value = 0;
            medications.forEach(m => m.checked = false); renderMedications();
            document.getElementById('mealsList').innerHTML = '';
            document.getElementById('currentWeightDisplay').textContent = '--';
            todayWeightStat.textContent = '--'; todayWalkStat.textContent = '--'; todayPlankStat.textContent = '--';
            todayWaterStat.textContent = '0/8'; updateWaterDisplay();
        }

        // Chart & History (Simplified for brevity but fully functional)
        function loadWeightHistory() {
            if (!currentUser) return;
            database.ref('users/' + currentUser.uid + '/days').once('value').then(snap => {
                const d = snap.val();
                if(!d) return;
                const data = Object.keys(d).filter(k => d[k].weight).map(k => ({x: k, y: d[k].weight})).sort((a,b) => new Date(a.x)-new Date(b.x));
                const ctx = document.getElementById('weightChart').getContext('2d');
                if(weightChart) weightChart.destroy();
                weightChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(i => i.x.split('-').slice(1).reverse().join('/')),
                        datasets: [{ label: 'Ø§Ù„ÙˆØ²Ù†', data: data.map(i => i.y), borderColor: '#764ba2', tension: 0.4, fill: true, backgroundColor: 'rgba(118,75,162,0.1)' }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: {grid: {display:false}}, y: {grid: {display:false}} } }
                });
            });
        }

        function loadHistory() {
            if (!currentUser) return;
            database.ref('users/' + currentUser.uid + '/days').limitToLast(10).once('value').then(snap => {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                const d = snap.val();
                if(d) {
                    Object.keys(d).sort().reverse().forEach(k => {
                        const day = d[k];
                        list.innerHTML += `<div class="p-2 border-bottom"><div class="d-flex justify-content-between"><strong>${k}</strong> <span>${day.weight || '?'} ÙƒØ¬Ù…</span></div><small class="text-muted">Ù…Ø´ÙŠ: ${day.walking||0} | Ø¨Ù„Ø§Ù†Ùƒ: ${day.plank||0}</small></div>`;
                    });
                }
            });
        }
    </script>
</body>
</html>
