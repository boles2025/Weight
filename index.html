<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø±Ø´Ø§Ù‚Ø© 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body { font-family: 'Tajawal', sans-serif; }
        #loading-overlay { transition: opacity 0.4s ease; }
        .hidden-loader { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-12">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠØ© -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center text-center px-6">
        <div class="animate-spin h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
        <p class="text-slate-600 font-bold text-lg">Ø¬Ø§Ø±Ù ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-[150] bg-green-500 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 opacity-0 pointer-events-none transition-opacity duration-300">
        <i class="fas fa-check-circle"></i>
        <span id="toast-msg">ØªÙ… Ø§Ù„Ø­ÙØ¸</span>
    </div>

    <div class="max-w-5xl mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
            <div>
                <h1 class="text-3xl font-black text-blue-600">Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø±Ø´Ø§Ù‚Ø© 2026 ğŸš€</h1>
                <div class="flex items-center gap-2 text-slate-500 mt-1">
                    <i id="sync-icon" class="fas fa-circle-notch animate-spin"></i>
                    <span id="sync-status" class="text-xs font-medium">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...</span>
                </div>
            </div>

            <div class="bg-white p-2 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-2">
                <button onclick="changeDate(-1)" class="p-2 hover:bg-slate-50 rounded-xl text-slate-400"><i class="fas fa-chevron-right"></i></button>
                <div class="flex items-center gap-2 px-4 border-x border-slate-100">
                    <i class="fas fa-calendar-alt text-blue-500"></i>
                    <input type="date" id="date-picker" class="font-bold bg-transparent border-none focus:ring-0 outline-none">
                </div>
                <button onclick="changeDate(1)" class="p-2 hover:bg-slate-50 rounded-xl text-slate-400"><i class="fas fa-chevron-left"></i></button>
            </div>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 space-y-6">
                <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h2 class="text-xl font-bold flex items-center gap-2 mb-6"><i class="fas fa-chart-line text-blue-500"></i> Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl text-center">
                            <p class="text-slate-500 text-xs mb-1">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                            <span id="val-weight" class="text-3xl font-black">--</span> <span class="text-xs text-slate-400">ÙƒØ¬Ù…</span>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-2xl text-center text-blue-600">
                            <p class="text-xs mb-1">Ø´Ø±Ø¨ Ø§Ù„Ù…ÙŠØ§Ù‡</p>
                            <span id="val-water" class="text-3xl font-black">0</span> <span class="text-xs">Ù„ØªØ±</span>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-2xl text-center text-emerald-600">
                            <p class="text-xs mb-1">Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø´ÙŠ</p>
                            <span id="val-steps" class="text-3xl font-black">0</span> <span class="text-xs">Ø¯Ù‚ÙŠÙ‚Ø©</span>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100 flex flex-wrap gap-4 justify-center">
                        <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl">
                            <input type="number" id="input-weight" placeholder="Ø§Ù„ÙˆØ²Ù†.." class="bg-transparent border-none w-20 px-2 outline-none text-center">
                            <button onclick="updateWeight()" class="bg-blue-600 text-white p-2 rounded-lg"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="adjustWater(0.25)" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl font-bold">+ Ù…Ø§Ø¡</button>
                            <button onclick="adjustSteps(5)" class="bg-emerald-50 text-emerald-600 px-4 py-2 rounded-xl font-bold">+ Ù…Ø´ÙŠ</button>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-history text-blue-500"></i> Ø¢Ø®Ø± Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</h2>
                    <div id="history-list" class="space-y-3"></div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…Ø·ÙˆØ± -->
                <div class="bg-slate-900 text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                    <h2 class="text-xl font-bold text-orange-400 mb-6 flex items-center gap-2"><i class="fas fa-stopwatch"></i> Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ§Ù…</h2>
                    
                    <div id="fasting-setup">
                        <label class="text-xs text-slate-400 block mb-3">Ø­Ø¯Ø¯ Ù‡Ø¯Ù Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØµÙŠØ§Ù…:</label>
                        <div class="grid grid-cols-4 gap-2 mb-6">
                            <button onclick="setFastingGoal(12)" class="goal-btn py-2 rounded-xl text-xs font-bold bg-slate-800 text-slate-400">12Ø³</button>
                            <button onclick="setFastingGoal(16)" class="goal-btn py-2 rounded-xl text-xs font-bold bg-orange-500 text-white">16Ø³</button>
                            <button onclick="setFastingGoal(18)" class="goal-btn py-2 rounded-xl text-xs font-bold bg-slate-800 text-slate-400">18Ø³</button>
                            <button onclick="setFastingGoal(20)" class="goal-btn py-2 rounded-xl text-xs font-bold bg-slate-800 text-slate-400">20Ø³</button>
                        </div>
                        <button onclick="startFasting()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 rounded-2xl font-bold transition-all shadow-lg active:scale-95">
                            Ø§Ø¨Ø¯Ø£ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ø¢Ù†
                        </button>
                    </div>

                    <div id="fasting-active" class="hidden space-y-6 text-center">
                        <div>
                            <p class="text-slate-400 text-xs mb-1 italic">Ø£Ù†Øª ØµØ§Ø¦Ù… Ù…Ù†Ø°:</p>
                            <p id="fasting-timer" class="text-3xl font-black text-orange-400">00:00:00</p>
                        </div>
                        
                        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
                        <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                            <div id="fasting-progress-bar" class="h-full bg-orange-500 transition-all duration-1000" style="width: 0%"></div>
                        </div>

                        <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                            <p class="text-slate-400 text-[10px] mb-1">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</p>
                            <p id="fasting-end-time" class="text-xl font-black text-green-400">--:--</p>
                        </div>

                        <button onclick="stopFasting()" class="w-full py-2 border border-slate-700 hover:bg-slate-800 rounded-xl text-[10px] text-slate-400 transition-colors">
                            Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù… Ù…Ø¨ÙƒØ±Ø§Ù‹
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl border border-slate-100">
                    <button onclick="confirmReset()" class="w-full text-red-500 text-xs font-bold py-2">Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkqqU_3KbEW_FFFK-Sy8QASI0-jsAfycM",
            authDomain: "health-ea6cd.firebaseapp.com",
            projectId: "health-ea6cd",
            storageBucket: "health-ea6cd.firebasestorage.app",
            messagingSenderId: "836059005460",
            appId: "1:836059005460:web:9d3768d1925288322e9d01"
        };

        let db, auth;
        let currentUser = null;
        let globalData = JSON.parse(localStorage.getItem('health_data_v3')) || { 
            settings: { weightHistory: [], fastingGoal: 16 }, 
            records: {} 
        };
        let selectedDate = new Date().toISOString().split('T')[0];
        let isCloudMode = false;

        const forceLoad = () => {
            const loader = document.getElementById('loading-overlay');
            if (loader) loader.classList.add('hidden-loader');
            updateUI();
            document.getElementById('sync-icon').className = "fas fa-hdd text-amber-500";
            document.getElementById('sync-status').innerText = "ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù†Ø´Ø·";
        };

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            const authTimeout = setTimeout(forceLoad, 1500);

            signInAnonymously(auth).catch(() => forceLoad());

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    clearTimeout(authTimeout);
                    currentUser = user;
                    isCloudMode = true;
                    document.getElementById('sync-icon').className = "fas fa-cloud text-green-500";
                    document.getElementById('sync-status').innerText = "Ù…ØªØµÙ„ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹";
                    syncData();
                }
            });
        } catch (e) {
            forceLoad();
        }

        function syncData() {
            const docRef = doc(db, 'artifacts', 'health-2026', 'users', currentUser.uid, 'data', 'main');
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    globalData = snap.data();
                    localStorage.setItem('health_data_v3', JSON.stringify(globalData));
                }
                updateUI();
                forceLoad();
            }, () => forceLoad());
        }

        function updateUI() {
            const day = globalData.records[selectedDate] || { water: 0, steps: 0, weight: null };
            document.getElementById('val-weight').innerText = day.weight || '--';
            document.getElementById('val-water').innerText = day.water || 0;
            document.getElementById('val-steps').innerText = day.steps || 0;
            document.getElementById('date-picker').value = selectedDate;

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙŠØ§Ù…
            if (day.fastingStart) {
                document.getElementById('fasting-setup').classList.add('hidden');
                document.getElementById('fasting-active').classList.remove('hidden');
                runTimer(day.fastingStart);
            } else {
                document.getElementById('fasting-setup').classList.remove('hidden');
                document.getElementById('fasting-active').classList.add('hidden');
                updateGoalButtons(globalData.settings.fastingGoal || 16);
            }
            renderHistory();
        }

        function updateGoalButtons(goal) {
            document.querySelectorAll('.goal-btn').forEach(btn => {
                const isSelected = parseInt(btn.innerText) === goal;
                btn.classList.toggle('bg-orange-500', isSelected);
                btn.classList.toggle('text-white', isSelected);
                btn.classList.toggle('bg-slate-800', !isSelected);
                btn.classList.toggle('text-slate-400', !isSelected);
            });
        }

        function renderHistory() {
            const hist = globalData.settings.weightHistory || [];
            const container = document.getElementById('history-list');
            container.innerHTML = hist.length ? '' : '<p class="text-center text-slate-400 text-xs py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
            [...hist].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 3).forEach(item => {
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <span class="text-xs font-bold text-slate-500">${item.date}</span>
                        <span class="font-black text-blue-600">${item.value} ÙƒØ¬Ù…</span>
                    </div>`;
            });
        }

        function runTimer(startStr) {
            const start = new Date(startStr);
            const goalHours = globalData.settings.fastingGoal || 16;
            
            // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø¥ÙØ·Ø§Ø±
            const end = new Date(start.getTime() + goalHours * 3600000);
            document.getElementById('fasting-end-time').innerText = end.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

            const update = () => {
                const now = new Date();
                const diff = now - start;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                document.getElementById('fasting-timer').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                const progress = Math.min(100, (diff / (goalHours * 3600000)) * 100);
                document.getElementById('fasting-progress-bar').style.width = progress + '%';
                
                if (document.getElementById('fasting-active').offsetParent) setTimeout(update, 1000);
            };
            update();
        }

        // Ø§Ù„Ø£ÙØ¹Ø§Ù„ (Actions)
        window.setFastingGoal = (h) => {
            globalData.settings.fastingGoal = h;
            updateGoalButtons(h);
            saveData();
        };

        window.changeDate = (val) => {
            let d = new Date(selectedDate); d.setDate(d.getDate() + val);
            selectedDate = d.toISOString().split('T')[0]; updateUI();
        };

        window.updateWeight = async () => {
            const val = parseFloat(document.getElementById('input-weight').value);
            if (!val) return;
            if (!globalData.records[selectedDate]) globalData.records[selectedDate] = { water: 0, steps: 0 };
            globalData.records[selectedDate].weight = val;
            globalData.settings.weightHistory = globalData.settings.weightHistory.filter(h => h.date !== selectedDate);
            globalData.settings.weightHistory.push({ date: selectedDate, value: val });
            document.getElementById('input-weight').value = '';
            await saveData();
        };

        window.adjustWater = async (v) => {
            if (!globalData.records[selectedDate]) globalData.records[selectedDate] = { water: 0, steps: 0 };
            globalData.records[selectedDate].water = Math.max(0, (globalData.records[selectedDate].water || 0) + v);
            await saveData();
        };

        window.adjustSteps = async (v) => {
            if (!globalData.records[selectedDate]) globalData.records[selectedDate] = { water: 0, steps: 0 };
            globalData.records[selectedDate].steps = Math.max(0, (globalData.records[selectedDate].steps || 0) + v);
            await saveData();
        };

        window.startFasting = async () => {
            if (!globalData.records[selectedDate]) globalData.records[selectedDate] = { water: 0, steps: 0 };
            globalData.records[selectedDate].fastingStart = new Date().toISOString();
            await saveData();
        };

        window.stopFasting = async () => {
            globalData.records[selectedDate].fastingStart = null;
            await saveData();
        };

        async function saveData() {
            localStorage.setItem('health_data_v3', JSON.stringify(globalData));
            updateUI();
            if (isCloudMode && currentUser) {
                try {
                    await setDoc(doc(db, 'artifacts', 'health-2026', 'users', currentUser.uid, 'data', 'main'), globalData);
                } catch (e) { console.error("Cloud save failed"); }
            }
            showToast();
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 2000);
        }

        window.confirmReset = () => {
            if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                localStorage.removeItem('health_data_v3');
                location.reload();
            }
        };

        document.getElementById('date-picker').addEventListener('change', (e) => {
            selectedDate = e.target.value; updateUI();
        });
    </script>
</body>
</html>
